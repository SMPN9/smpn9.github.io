<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming (Mic + MP3)</title>
</head>
<body>
    <h3>Pilih 77 MP3/MP4 & Kirim Stream</h3>
    <input type="file" id="mp3Input">
    <audio id="mp3Player" controls></audio>
    <input type="file" id="mp4Input">
    <audio id="mp4Player" controls></audio>
    <br>
    <button onclick="startStreaming()">Buat Permintaan</button>
    <button onclick="send2()">SetJawaban</button>
    
    <h3>Kontrol Mic & MP3</h3>
    <button id="toggleMic" onclick="toggleMic()" disabled>Matikan Mic</button>
    <button id="toggleMp3" onclick="toggleMp3()" disabled>Matikan MP3</button>
    
    <textarea id="sdpInput" placeholder="Tempel SDP dari A di sini" rows="6" cols="50"></textarea>

    <script>
        let pc;
        let micStream, mp3Stream;
        let sender;
        let audioContext = new AudioContext();
        let mixedStream;
        
        async function startStreaming() {
            pc = new RTCPeerConnection({
                iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
            });
            
            micStream = await navigator.mediaDevices.getUserMedia({ 
                audio: { 
                    echoCancellation: true,  
                    noiseSuppression: true,
                    autoGainControl: true,
                    channelCount: 1,
                    sampleRate: 16000,
                } 
            });
            
            const micSource = audioContext.createMediaStreamSource(micStream);
            const dest = audioContext.createMediaStreamDestination();
            micSource.connect(dest);
            
            mixedStream = dest.stream;
            sender = pc.addTrack(mixedStream.getAudioTracks()[0], mixedStream);
            
            pc.ontrack = (event) => {
                const remoteAudio = new Audio();
                remoteAudio.srcObject = event.streams[0];
                remoteAudio.autoplay = true;
                document.body.appendChild(remoteAudio);
            };
            
            pc.onicecandidate = event => {
                if (!event.candidate) {
                    document.getElementById('sdpInput').value = JSON.stringify(pc.localDescription);
                    send1(JSON.stringify(pc.localDescription));
                }
            };
            
            let offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            document.getElementById("toggleMic").disabled = false;
        }
        
        async function handleAnswer() {
            let sdp = JSON.parse(document.getElementById('sdpInput').value);
            await pc.setRemoteDescription(new RTCSessionDescription(sdp));
            alert("Koneksi berhasil!");
        }
        
        function toggleMic() {
            if (micStream) {
                let track = micStream.getAudioTracks()[0];
                track.enabled = !track.enabled;
                document.getElementById("toggleMic").innerText = track.enabled ? "Matikan Mic" : "Nyalakan Mic";
            }
        }
        
        function send1(isi) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "https://script.google.com/macros/s/AKfycbxLAmvC07Ri3CA37iNDt7XXIk317-gfCNuy4qtLYshUnQjGsVSqJ7FMzAeRh_USz8M6qg/exec?", true);
            xhr.onload = function () {
                alert(xhr.responseText);
            };
            var data = JSON.stringify({ kode: 1, isi: isi });
            xhr.send(data);
        }
        
        function send2() {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "https://script.google.com/macros/s/AKfycbxLAmvC07Ri3CA37iNDt7XXIk317-gfCNuy4qtLYshUnQjGsVSqJ7FMzAeRh_USz8M6qg/exec?", true);
            xhr.onload = function () {
                document.getElementById('sdpInput').value = xhr.responseText;
                handleAnswer();
            };
            var data = JSON.stringify({ kode: 22, isi: '-' });
            xhr.send(data);
        }
    </script>
</body>
</html>
