<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Penyiar & Pendengar</title>
</head>
<body>
    <h2>ğŸ¤ WebRTC Streaming Audio ğŸ¶</h2>

    <h3>Penyiar (Broadcaster)</h3>
    <button id="startBroadcast">Mulai Siaran</button>
    <input type="file" id="audioFile" accept="audio/*">
    <audio id="audioPlayer" controls></audio>

    <h3>Pendengar (Listener)</h3>
    <button id="startListening">Sambungkan ke Siaran</button>
    <audio id="listenerPlayer" controls autoplay></audio>

    <script>
        let pc = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        });

        let isBroadcaster = false;

        document.getElementById("startBroadcast").onclick = async function() {
            isBroadcaster = true;
            let micStream = await navigator.mediaDevices.getUserMedia({ audio: true });

            let fileInput = document.getElementById("audioFile");
            fileInput.onchange = async () => {
                let file = fileInput.files[0];
                if (!file) return;

                let audioPlayer = document.getElementById("audioPlayer");
                audioPlayer.src = URL.createObjectURL(file);
                
                await audioPlayer.play().catch(() => {
                    alert("Klik tombol play untuk memutar lagu.");
                });

                let audioContext = new AudioContext();
                let micSource = audioContext.createMediaStreamSource(micStream);
                let songSource = audioContext.createMediaElementSource(audioPlayer);
                let destination = audioContext.createMediaStreamDestination();

                micSource.connect(destination);
                songSource.connect(audioContext.destination);
                songSource.connect(destination);

                let mixedStream = destination.stream;
                mixedStream.getTracks().forEach(track => pc.addTrack(track, mixedStream));

                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log("ğŸ“¡ Penyiar mengirim ICE:", event.candidate);
                        localStorage.setItem("webrtc_ice_candidate", JSON.stringify(event.candidate));
                    }
                };

                let offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                localStorage.setItem("webrtc_offer", JSON.stringify(offer));

                alert("âœ… Siaran dimulai! Klik 'Sambungkan ke Siaran' di tab lain.");
            };
        };

        document.getElementById("startListening").onclick = async function() {
            let offer = JSON.parse(localStorage.getItem("webrtc_offer"));
            if (!offer) {
                alert("âŒ Belum ada siaran tersedia.");
                return;
            }

            await pc.setRemoteDescription(offer);
            let answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            localStorage.setItem("webrtc_answer", JSON.stringify(answer));

            let iceCandidate = JSON.parse(localStorage.getItem("webrtc_ice_candidate"));
            if (iceCandidate) {
                console.log("ğŸ“¥ Pendengar menerima ICE dari penyiar:", iceCandidate);
                await pc.addIceCandidate(new RTCIceCandidate(iceCandidate));
            }

            pc.ontrack = (event) => {
                console.log("ğŸ§ Menerima audio stream:", event.streams);
                let audioPlayer = document.getElementById("listenerPlayer");
                audioPlayer.srcObject = event.streams[0];

                setTimeout(() => {
                    audioPlayer.play().catch(() => {
                        alert("Klik tombol play di pendengar untuk mendengar suara.");
                    });
                }, 500);
            };

            alert("âœ… Terhubung ke siaran! Dengarkan audio sekarang.");
        };
    </script>
</body>
</html>
